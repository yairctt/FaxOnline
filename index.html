<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FAX — Compilador</title>
<link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --paper:   #f5f0e8;
  --paper2:  #ede8df;
  --paper3:  #e4ddd2;
  --ink:     #1a1612;
  --ink2:    #4a4440;
  --ink3:    #8a8078;
  --rule:    #cfc8bc;
  --rule2:   #b8b0a4;
  --red:     #c0392b;
  --stamp:   #1a1612;
  --mono:    'Courier Prime', monospace;
  --sans:    'DM Sans', sans-serif;
}

html,body{height:100%;background:var(--paper);color:var(--ink);font-family:var(--sans);overflow:hidden}

/* grain texture */
body::after{
  content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;z-index:1000;
}

/* ── LAYOUT ── */
.app{display:grid;grid-template-rows:56px 1fr;grid-template-columns:1fr 1fr;height:100vh}

/* ── HEADER ── */
header{
  grid-column:1/-1;
  display:flex;align-items:center;gap:0;
  background:var(--ink);color:var(--paper);
  padding:0;
  position:relative;z-index:10;
}

.hdr-brand{
  display:flex;align-items:center;gap:14px;
  padding:0 24px;
  border-right:1px solid rgba(255,255,255,.12);
  height:100%;
}
.brand-mark{
  font-family:var(--mono);font-size:22px;font-weight:700;
  letter-spacing:6px;color:var(--paper);
  border:2px solid var(--paper);
  padding:2px 8px;
  line-height:1;
}
.brand-sub{
  font-family:var(--mono);font-size:10px;
  color:rgba(245,240,232,.45);
  letter-spacing:2px;text-transform:uppercase;
  line-height:1.4;
}

.hdr-actions{
  display:flex;align-items:center;gap:8px;
  padding:0 20px;
}

.btn-compile{
  display:flex;align-items:center;gap:8px;
  padding:8px 20px;
  background:var(--paper);color:var(--ink);
  border:none;border-radius:2px;
  font-family:var(--mono);font-size:13px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;
  cursor:pointer;transition:all .15s;
}
.btn-compile:hover{background:#fff;transform:translateY(-1px);box-shadow:0 3px 12px rgba(0,0,0,.3)}
.btn-compile:active{transform:translateY(0)}
.btn-compile.loading{opacity:.6;pointer-events:none}

.btn-clear{
  padding:8px 14px;
  background:transparent;color:rgba(245,240,232,.5);
  border:1px solid rgba(255,255,255,.15);border-radius:2px;
  font-family:var(--mono);font-size:12px;
  cursor:pointer;transition:all .15s;letter-spacing:.5px;
}
.btn-clear:hover{color:var(--paper);border-color:rgba(255,255,255,.4)}

.btn-settings{
  padding:8px 14px;
  background:transparent;color:rgba(245,240,232,.5);
  border:1px solid rgba(255,255,255,.15);border-radius:2px;
  font-family:var(--mono);font-size:12px;
  cursor:pointer;transition:all .15s;letter-spacing:.5px;
  margin-left:4px;
}
.btn-settings:hover{color:var(--paper);border-color:rgba(255,255,255,.4)}

.hdr-right{
  margin-left:auto;
  display:flex;align-items:center;gap:16px;
  padding:0 20px;
}
.status-area{
  display:flex;align-items:center;gap:8px;
  font-family:var(--mono);font-size:11px;
  color:rgba(245,240,232,.4);letter-spacing:.5px;
}
.status-dot{
  width:6px;height:6px;border-radius:50%;
  background:rgba(245,240,232,.2);
  transition:background .3s,box-shadow .3s;
}
.status-dot.ok{background:#5cb85c;box-shadow:0 0 6px #5cb85c}
.status-dot.err{background:var(--red);box-shadow:0 0 6px var(--red)}
.status-dot.run{background:#f0ad4e;box-shadow:0 0 6px #f0ad4e;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.backend-pill{
  font-family:var(--mono);font-size:10px;
  padding:3px 10px;border-radius:20px;
  border:1px solid rgba(255,255,255,.15);
  color:rgba(245,240,232,.35);letter-spacing:.5px;
  transition:all .3s;
}
.backend-pill.online{color:#5cb85c;border-color:rgba(92,184,92,.4)}
.backend-pill.offline{color:var(--red);border-color:rgba(192,57,43,.4)}

/* ── EDITOR PANEL ── */
.editor-panel{
  display:flex;flex-direction:column;
  border-right:2px solid var(--ink);
  background:var(--paper);
  overflow:hidden;
}

.panel-bar{
  display:flex;align-items:center;
  padding:0 16px;height:36px;
  background:var(--paper2);
  border-bottom:1px solid var(--rule);
  flex-shrink:0;
}
.panel-label{
  font-family:var(--mono);font-size:10px;
  color:var(--ink3);letter-spacing:2px;text-transform:uppercase;
}
.file-name{
  margin-left:auto;
  font-family:var(--mono);font-size:11px;color:var(--ink3);
}

.editor-wrap{
  flex:1;display:flex;overflow:hidden;
}
.line-nums{
  padding:16px 0 16px 0;
  min-width:48px;
  background:var(--paper2);
  border-right:1px solid var(--rule);
  text-align:right;
  font-family:var(--mono);font-size:12px;line-height:21px;
  color:var(--ink3);user-select:none;overflow:hidden;flex-shrink:0;
}
.line-nums span{display:block;padding-right:12px}

#code{
  flex:1;padding:16px;
  background:transparent;border:none;outline:none;
  color:var(--ink);font-family:var(--mono);
  font-size:13px;line-height:21px;
  resize:none;tab-size:2;
  caret-color:var(--red);
}
#code::selection{background:rgba(192,57,43,.15)}
#code::placeholder{color:var(--ink3)}

/* ── OUTPUT PANEL ── */
.output-panel{
  display:flex;flex-direction:column;
  background:var(--paper);overflow:hidden;
}

/* ── TABS ── */
.tabs{
  display:flex;align-items:flex-end;
  background:var(--paper2);
  border-bottom:2px solid var(--ink);
  padding:0 0 0 0;
  overflow-x:auto;flex-shrink:0;
}
.tabs::-webkit-scrollbar{height:0}

.tab{
  padding:0 18px;height:36px;
  display:flex;align-items:center;gap:7px;
  font-family:var(--mono);font-size:11px;
  color:var(--ink3);letter-spacing:.5px;
  cursor:pointer;border-bottom:2px solid transparent;
  margin-bottom:-2px;white-space:nowrap;
  transition:color .15s,border-color .15s,background .15s;
  border-right:1px solid var(--rule);
}
.tab:hover{color:var(--ink2);background:var(--paper3)}
.tab.active{
  color:var(--ink);background:var(--paper);
  border-bottom:2px solid var(--ink);
  font-weight:700;
}
.tab-count{
  font-size:9px;padding:1px 5px;border-radius:2px;
  background:var(--paper3);color:var(--ink3);
  font-family:var(--mono);
}
.tab.active .tab-count{background:var(--ink);color:var(--paper)}
.tab-count.has-err{background:var(--red);color:#fff}

/* ── TAB CONTENT ── */
.output-body{flex:1;overflow-y:auto;padding:20px}
.output-body::-webkit-scrollbar{width:4px}
.output-body::-webkit-scrollbar-track{background:transparent}
.output-body::-webkit-scrollbar-thumb{background:var(--rule2);border-radius:2px}

.tab-panel{display:none}
.tab-panel.active{display:block}

/* ── EMPTY STATE ── */
.empty{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;height:calc(100vh - 200px);
  gap:10px;color:var(--ink3);text-align:center;
}
.empty-glyph{
  font-family:var(--mono);font-size:48px;
  color:var(--rule2);line-height:1;
}
.empty-t{font-family:var(--mono);font-size:13px;color:var(--ink3);letter-spacing:1px}
.empty-s{font-family:var(--mono);font-size:11px;color:var(--rule2);margin-top:4px}

/* ── RESULT SUCCESS ── */
.success-block{
  border:2px solid var(--ink);padding:20px 24px;
  margin-bottom:16px;
  display:flex;align-items:flex-start;gap:16px;
}
.success-stamp{
  font-family:var(--mono);font-size:28px;font-weight:700;
  color:var(--ink);border:3px solid var(--ink);
  padding:4px 10px;line-height:1;letter-spacing:2px;
  transform:rotate(-2deg);flex-shrink:0;
}
.success-title{font-family:var(--mono);font-size:15px;font-weight:700;letter-spacing:1px}
.success-sub{font-family:var(--mono);font-size:11px;color:var(--ink2);margin-top:4px;letter-spacing:.5px}

.stats-row{display:flex;gap:0;border:1px solid var(--rule2)}
.stat{
  flex:1;padding:14px 16px;text-align:center;
  border-right:1px solid var(--rule2);
}
.stat:last-child{border-right:none}
.stat-n{font-family:var(--mono);font-size:28px;font-weight:700;color:var(--ink)}
.stat-l{font-family:var(--mono);font-size:9px;color:var(--ink3);letter-spacing:2px;text-transform:uppercase;margin-top:2px}

/* ── ERROR BLOCK ── */
.err-header{
  display:flex;align-items:center;gap:12px;
  border:2px solid var(--ink);padding:14px 18px;
  margin-bottom:12px;
}
.err-stamp{
  font-family:var(--mono);font-size:11px;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;
  border:2px solid var(--red);color:var(--red);
  padding:4px 8px;flex-shrink:0;
}
.err-title{font-family:var(--mono);font-size:13px;font-weight:700}
.err-sub{font-family:var(--mono);font-size:11px;color:var(--ink2);margin-top:2px}

/* ── ERROR LIST ── */
.err-list{display:flex;flex-direction:column;gap:0}

.err-row{
  display:grid;
  grid-template-columns:90px 1fr;
  border:1px solid var(--rule);
  border-top:none;
  cursor:pointer;
  transition:background .1s;
  animation:fadeIn .2s ease both;
}
.err-row:first-child{border-top:1px solid var(--rule)}
.err-row:hover{background:var(--paper2)}

@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}

.err-loc{
  padding:10px 12px;
  border-right:1px solid var(--rule);
  font-family:var(--mono);font-size:11px;
  color:var(--ink3);line-height:1.5;
  display:flex;flex-direction:column;justify-content:center;
  background:var(--paper2);
}
.err-loc strong{color:var(--ink);font-size:12px}

.err-body{
  padding:10px 14px;
  font-family:var(--mono);font-size:12px;
  color:var(--ink2);line-height:1.6;
  display:flex;flex-direction:column;justify-content:center;
}
.err-token{
  display:inline-block;
  background:var(--paper3);
  padding:0 5px;border-radius:1px;
  color:var(--ink);font-weight:700;margin-bottom:2px;
}
.err-msg{color:var(--ink2)}

/* ── RAW OUTPUT ── */
.raw{
  font-family:var(--mono);font-size:12px;line-height:1.8;
  color:var(--ink2);white-space:pre-wrap;word-break:break-all;
  border:1px solid var(--rule);padding:16px;background:var(--paper2);
}

/* ── SETTINGS PANEL ── */
.settings-block{
  border:1px solid var(--rule);
  margin-bottom:16px;
}
.settings-title{
  padding:10px 16px;
  background:var(--paper2);
  border-bottom:1px solid var(--rule);
  font-family:var(--mono);font-size:10px;
  letter-spacing:2px;text-transform:uppercase;color:var(--ink3);
}
.settings-body{padding:16px}
.setting-row{margin-bottom:14px}
.setting-row:last-child{margin-bottom:0}
.setting-label{
  font-family:var(--mono);font-size:11px;
  color:var(--ink2);letter-spacing:.5px;
  margin-bottom:6px;display:block;
}
.setting-input{
  width:100%;padding:8px 12px;
  border:1px solid var(--rule2);border-radius:2px;
  background:var(--paper);color:var(--ink);
  font-family:var(--mono);font-size:12px;
  outline:none;transition:border-color .15s;
}
.setting-input:focus{border-color:var(--ink)}

.btn-save-settings{
  padding:8px 18px;
  background:var(--ink);color:var(--paper);
  border:none;border-radius:2px;
  font-family:var(--mono);font-size:12px;font-weight:700;
  letter-spacing:1px;cursor:pointer;transition:opacity .15s;
}
.btn-save-settings:hover{opacity:.8}

.settings-saved{
  display:inline-block;margin-left:10px;
  font-family:var(--mono);font-size:11px;color:var(--ink3);
  opacity:0;transition:opacity .3s;
}
.settings-saved.show{opacity:1}

/* Instrucciones para agregar pestañas */
.add-tab-guide{
  border:1px dashed var(--rule2);padding:16px;
  font-family:var(--mono);font-size:11px;
  color:var(--ink3);line-height:1.8;
}
.add-tab-guide code{
  background:var(--paper2);padding:1px 5px;
  border-radius:1px;color:var(--ink2);
}

/* ── OVERLAY sin conexión ── */
#overlay{
  display:none;position:fixed;inset:0;
  background:rgba(245,240,232,.92);
  z-index:200;
  flex-direction:column;align-items:center;justify-content:center;
  gap:14px;text-align:center;
}
#overlay.show{display:flex}
.ov-title{font-family:var(--mono);font-size:18px;font-weight:700;letter-spacing:1px}
.ov-sub{font-family:var(--mono);font-size:12px;color:var(--ink2);max-width:400px;line-height:1.7}
.ov-code{
  font-family:var(--mono);font-size:12px;
  background:var(--ink);color:var(--paper);
  padding:10px 20px;border-radius:2px;letter-spacing:.5px;
}
.btn-dismiss{
  padding:8px 18px;background:transparent;
  border:1px solid var(--rule2);border-radius:2px;
  font-family:var(--mono);font-size:12px;cursor:pointer;
  color:var(--ink2);transition:all .15s;margin-top:4px;
}
.btn-dismiss:hover{border-color:var(--ink);color:var(--ink)}

/* responsive */
@media(max-width:768px){
  .app{grid-template-columns:1fr;grid-template-rows:56px 50vh 1fr}
  .editor-panel{border-right:none;border-bottom:2px solid var(--ink)}
}
</style>
</head>
<body>

<div id="overlay">
  <div class="ov-title">BACKEND NO DISPONIBLE</div>
  <div class="ov-sub">El servidor Java no responde.<br>Asegúrate de que esté corriendo:</div>
  <div class="ov-code" id="ov-url">java -jar fax-backend.jar</div>
  <div class="ov-sub" style="margin-top:4px">Luego recarga la página.</div>
  <button class="btn-dismiss" onclick="document.getElementById('overlay').classList.remove('show')">Cerrar</button>
</div>

<div class="app">

  <!-- ── HEADER ── -->
  <header>
    <div class="hdr-brand">
      <div class="brand-mark">FAX</div>
      <div class="brand-sub">Compilador<br>JavaCC</div>
    </div>
    <div class="hdr-actions">
      <button class="btn-compile" id="btn-compile" onclick="compilar()">▶ COMPILAR</button>
      <button class="btn-clear" onclick="limpiar()">LIMPIAR</button>
      <button class="btn-settings" onclick="switchTab('config')">⚙ CONFIG</button>
    </div>
    <div class="hdr-right">
      <span id="backend-pill" class="backend-pill">● BACKEND</span>
      <div class="status-area">
        <div class="status-dot" id="sdot"></div>
        <span id="stxt">listo</span>
      </div>
    </div>
  </header>

  <!-- ── EDITOR ── -->
  <section class="editor-panel">
    <div class="panel-bar">
      <span class="panel-label">Código fuente</span>
      <span class="file-name">programa.fax</span>
    </div>
    <div class="editor-wrap">
      <div class="line-nums" id="lnums"><span>1</span></div>
      <textarea id="code" spellcheck="false"
        placeholder="inicio&#10;  // escribe tu código FAX aquí&#10;fin"></textarea>
    </div>
  </section>

  <!-- ── OUTPUT ── -->
  <section class="output-panel">

    <!-- TABS — agrega más <div class="tab"> aquí para nuevas fases -->
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="resultado" onclick="switchTab('resultado')">
        RESULTADO <span class="tab-count" id="tc-resultado">—</span>
      </div>
      <div class="tab" data-tab="errores" onclick="switchTab('errores')">
        ERRORES <span class="tab-count" id="tc-errores">0</span>
      </div>
      <div class="tab" data-tab="raw" onclick="switchTab('raw')">
        SALIDA RAW
      </div>
      <!-- NUEVAS PESTAÑAS: copia el bloque de arriba y cambia data-tab y el onclick -->
      <!-- Ejemplo:
      <div class="tab" data-tab="intermedio" onclick="switchTab('intermedio')">
        CÓD. INTERMEDIO
      </div>
      -->
      <div class="tab" data-tab="config" onclick="switchTab('config')">
        ⚙ CONFIG
      </div>
    </div>

    <div class="output-body">

      <!-- RESULTADO -->
      <div class="tab-panel active" id="panel-resultado">
        <div class="empty" id="empty-resultado">
          <div class="empty-glyph">[ ]</div>
          <div class="empty-t">SIN RESULTADOS</div>
          <div class="empty-s">Escribe código y presiona COMPILAR<br>o usa Ctrl+Enter</div>
        </div>
        <div id="result-content" style="display:none"></div>
      </div>

      <!-- ERRORES -->
      <div class="tab-panel" id="panel-errores">
        <div class="empty" id="empty-errores">
          <div class="empty-glyph">[✓]</div>
          <div class="empty-t">SIN ERRORES</div>
          <div class="empty-s">Los errores aparecerán aquí</div>
        </div>
        <div id="errors-content" style="display:none"></div>
      </div>

      <!-- RAW -->
      <div class="tab-panel" id="panel-raw">
        <div class="empty" id="empty-raw">
          <div class="empty-glyph">[~]</div>
          <div class="empty-t">SIN SALIDA</div>
          <div class="empty-s">La salida completa del compilador<br>aparecerá aquí</div>
        </div>
        <pre class="raw" id="raw-content" style="display:none"></pre>
      </div>

      <!-- NUEVAS PESTAÑAS: agrega un panel aquí con id="panel-NOMBRE"
      <div class="tab-panel" id="panel-intermedio">
        <div class="empty">
          <div class="empty-glyph">[~]</div>
          <div class="empty-t">CÓDIGO INTERMEDIO</div>
          <div class="empty-s">Disponible cuando implementes esta fase</div>
        </div>
      </div>
      -->

      <!-- CONFIG -->
      <div class="tab-panel" id="panel-config">
        <div class="settings-block">
          <div class="settings-title">Conexión al Backend</div>
          <div class="settings-body">
            <div class="setting-row">
              <label class="setting-label">URL del compilador (endpoint /compilar)</label>
              <input class="setting-input" id="cfg-url" type="text"
                placeholder="http://localhost:8080/compilar"/>
            </div>
            <div class="setting-row">
              <label class="setting-label">URL de ping (endpoint /ping)</label>
              <input class="setting-input" id="cfg-ping" type="text"
                placeholder="http://localhost:8080/ping"/>
            </div>
            <button class="btn-save-settings" onclick="guardarConfig()">GUARDAR</button>
            <span class="settings-saved" id="saved-msg">✓ Guardado</span>
          </div>
        </div>

        <div class="settings-block">
          <div class="settings-title">Cómo agregar nuevas pestañas</div>
          <div class="settings-body">
            <div class="add-tab-guide">
              1. Busca el comentario <code>&lt;!-- NUEVAS PESTAÑAS --&gt;</code> en el HTML<br>
              2. Descomenta el bloque de ejemplo o copia la estructura<br>
              3. Cambia <code>data-tab="intermedio"</code> por el nombre de tu fase<br>
              4. Agrega el panel correspondiente con <code>id="panel-NOMBRE"</code><br>
              5. En JavaScript, rellena el contenido del panel desde <code>renderResults()</code><br><br>
              Las pestañas actuales: <code>resultado</code> · <code>errores</code> · <code>raw</code> · <code>config</code>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>

<script>
// ══════════════════════════════════════════════
//  CONFIGURACIÓN — se guarda en sessionStorage
// ══════════════════════════════════════════════
const DEFAULTS = {
  url:  'https://fax-backend-production-6527.up.railway.app/compilar',
  ping: 'https://fax-backend-production-6527.up.railway.app/ping'
};

function getCfg(){
  return {
    url:  sessionStorage.getItem('fax_url')  || DEFAULTS.url,
    ping: sessionStorage.getItem('fax_ping') || DEFAULTS.ping
  };
}

function guardarConfig(){
  const url  = document.getElementById('cfg-url').value.trim();
  const ping = document.getElementById('cfg-ping').value.trim();
  if(url)  sessionStorage.setItem('fax_url',  url);
  if(ping) sessionStorage.setItem('fax_ping', ping);
  const msg = document.getElementById('saved-msg');
  msg.classList.add('show');
  setTimeout(()=>msg.classList.remove('show'), 2000);
  checkBackend();
}

// Inicializar inputs con valores actuales
window.addEventListener('DOMContentLoaded', ()=>{
  const cfg = getCfg();
  document.getElementById('cfg-url').value  = cfg.url;
  document.getElementById('cfg-ping').value = cfg.ping;
  updateLineNumbers();
  checkBackend();
  setInterval(checkBackend, 12000);
});

// ══════════════════════════════════════════════
//  TABS
// ══════════════════════════════════════════════
function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('active', t.dataset.tab === name);
  });
  document.querySelectorAll('.tab-panel').forEach(p=>{
    p.classList.toggle('active', p.id === 'panel-' + name);
  });
}

// ══════════════════════════════════════════════
//  EDITOR — números de línea
// ══════════════════════════════════════════════
const textarea = document.getElementById('code');
const lnums    = document.getElementById('lnums');

function updateLineNumbers(){
  const n = textarea.value.split('\n').length;
  lnums.innerHTML = Array.from({length:n},(_,i)=>`<span>${i+1}</span>`).join('');
  lnums.scrollTop = textarea.scrollTop;
}

textarea.addEventListener('input',  updateLineNumbers);
textarea.addEventListener('scroll', ()=>{ lnums.scrollTop = textarea.scrollTop; });
textarea.addEventListener('keydown', e=>{
  if(e.key==='Tab'){
    e.preventDefault();
    const s = textarea.selectionStart;
    textarea.value = textarea.value.substring(0,s)+'  '+textarea.value.substring(textarea.selectionEnd);
    textarea.selectionStart = textarea.selectionEnd = s+2;
    updateLineNumbers();
  }
  if((e.ctrlKey||e.metaKey) && e.key==='Enter'){e.preventDefault();compilar();}
});

// ══════════════════════════════════════════════
//  STATUS
// ══════════════════════════════════════════════
function setStatus(state, txt){
  const dot = document.getElementById('sdot');
  dot.className = 'status-dot' + (state ? ' '+state : '');
  document.getElementById('stxt').textContent = txt;
}

function setTabCount(id, txt, hasErr){
  const el = document.getElementById('tc-'+id);
  if(!el) return;
  el.textContent = txt;
  el.className   = 'tab-count' + (hasErr ? ' has-err' : '');
}

// ══════════════════════════════════════════════
//  BACKEND PING
// ══════════════════════════════════════════════
async function checkBackend(){
  const pill = document.getElementById('backend-pill');
  const cfg  = getCfg();
  try{
    const ctrl = new AbortController();
    const t    = setTimeout(()=>ctrl.abort(), 4000);
    const r    = await fetch(cfg.ping, {signal: ctrl.signal});
    clearTimeout(t);
    if(r.ok){
      pill.textContent = '● ONLINE';
      pill.className   = 'backend-pill online';
      return true;
    }
  }catch(_){}
  pill.textContent = '● OFFLINE';
  pill.className   = 'backend-pill offline';
  return false;
}

// ══════════════════════════════════════════════
//  LIMPIAR
// ══════════════════════════════════════════════
function limpiar(){
  textarea.value = '';
  updateLineNumbers();
  showEmpty('resultado');
  showEmpty('errores');
  showEmpty('raw');
  setTabCount('resultado','—',false);
  setTabCount('errores','0',false);
  setStatus('','listo');
  textarea.focus();
}

function showEmpty(tab){
  const empty = document.getElementById('empty-'+tab);
  if(empty) empty.style.display='';
  if(tab==='resultado'){ document.getElementById('result-content').style.display='none'; }
  if(tab==='errores')  { document.getElementById('errors-content').style.display='none'; }
  if(tab==='raw')      {
    document.getElementById('raw-content').style.display='none';
    document.getElementById('empty-raw').style.display='';
  }
}

// ══════════════════════════════════════════════
//  PARSE SALIDA DEL COMPILADOR
// ══════════════════════════════════════════════
function parseSalida(raw){
  const ok = raw.includes('✓') || /exitosa/i.test(raw);

  // Detecta líneas de error: "Línea N, Columna N: TIPO 'token' - descripción"
  const errores = [];
  raw.split('\n').forEach(line=>{
    const m = line.match(/Línea\s+(\d+),\s*Columna\s+(\d+):\s*([\w_]+)\s*('.*?')?\s*[-–]?\s*(.*)/i);
    if(m) errores.push({
      linea:  parseInt(m[1]),
      col:    parseInt(m[2]),
      tipo:   m[3]||'',
      token:  m[4]?m[4].replace(/'/g,''):'',
      msg:    m[5]?m[5].trim():''
    });
  });

  return {ok, errores};
}

// ══════════════════════════════════════════════
//  RENDER
// ══════════════════════════════════════════════
function renderResults(raw){
  const {ok, errores} = parseSalida(raw);
  const total = errores.length;

  // ── RAW ──
  const rawEl = document.getElementById('raw-content');
  rawEl.textContent = raw;
  rawEl.style.display = 'block';
  document.getElementById('empty-raw').style.display = 'none';

  // ── RESULTADO ──
  const rc = document.getElementById('result-content');
  document.getElementById('empty-resultado').style.display = 'none';
  rc.style.display = 'block';

  if(ok){
    rc.innerHTML = `
      <div class="success-block">
        <div class="success-stamp">OK</div>
        <div>
          <div class="success-title">COMPILACIÓN EXITOSA</div>
          <div class="success-sub">No se encontraron errores léxicos, sintácticos ni semánticos.</div>
        </div>
      </div>
      <div class="stats-row">
        <div class="stat"><div class="stat-n">0</div><div class="stat-l">Errores</div></div>
        <div class="stat"><div class="stat-n">✓</div><div class="stat-l">Estado</div></div>
        <div class="stat"><div class="stat-n">${textarea.value.split('\n').length}</div><div class="stat-l">Líneas</div></div>
      </div>`;
    setTabCount('resultado','✓',false);
    setTabCount('errores','0',false);
    setStatus('ok','sin errores');
  } else {
    rc.innerHTML = `
      <div class="err-header">
        <div class="err-stamp">ERROR</div>
        <div>
          <div class="err-title">${total} ERROR${total!==1?'ES':''} ENCONTRADO${total!==1?'S':''}</div>
          <div class="err-sub">Revisa la pestaña ERRORES para ver el detalle completo.</div>
        </div>
      </div>
      <div class="stats-row">
        <div class="stat"><div class="stat-n">${total}</div><div class="stat-l">Total</div></div>
        <div class="stat"><div class="stat-n">${textarea.value.split('\n').length}</div><div class="stat-l">Líneas</div></div>
        <div class="stat"><div class="stat-n">✗</div><div class="stat-l">Estado</div></div>
      </div>`;
    setTabCount('resultado', total+' err', true);
    setStatus('err', total+' error'+(total!==1?'es':''));
  }

  // ── ERRORES — lista unificada sin clasificar por tipo ──
  const ec    = document.getElementById('errors-content');
  const eEmpty= document.getElementById('empty-errores');

  if(total === 0){
    eEmpty.style.display='';
    ec.style.display='none';
    setTabCount('errores','0',false);
  } else {
    eEmpty.style.display='none';
    ec.style.display='block';
    setTabCount('errores', String(total), true);

    let html = `
      <div class="err-header" style="margin-bottom:12px">
        <div class="err-stamp">✗</div>
        <div>
          <div class="err-title">${total} ERROR${total!==1?'ES':''}</div>
          <div class="err-sub">Haz clic en una fila para saltar a esa línea en el editor.</div>
        </div>
      </div>
      <div class="err-list">`;

    errores.forEach((e,i)=>{
      html += `
        <div class="err-row" style="animation-delay:${i*30}ms" onclick="jumpTo(${e.linea})">
          <div class="err-loc">
            <strong>L.${e.linea}</strong>
            Col. ${e.col}
          </div>
          <div class="err-body">
            ${e.token ? `<span class="err-token">${e.token}</span>` : ''}
            <span class="err-msg">${e.msg||e.tipo||'—'}</span>
          </div>
        </div>`;
    });

    html += '</div>';
    ec.innerHTML = html;
  }
}

// ══════════════════════════════════════════════
//  SALTAR A LÍNEA
// ══════════════════════════════════════════════
function jumpTo(lineNum){
  const lines = textarea.value.split('\n');
  let pos = 0;
  for(let i=0;i<Math.min(lineNum-1,lines.length);i++) pos += lines[i].length+1;
  textarea.focus();
  textarea.setSelectionRange(pos, pos+(lines[lineNum-1]||'').length);
  textarea.scrollTop = Math.max(0,(lineNum-5))*21;
}

// ══════════════════════════════════════════════
//  COMPILAR
// ══════════════════════════════════════════════
async function compilar(){
  const codigo = textarea.value.trim();
  if(!codigo){ setStatus('err','editor vacío'); return; }

  const btn = document.getElementById('btn-compile');
  btn.classList.add('loading');
  btn.textContent = '⏳ COMPILANDO...';
  setStatus('run','compilando…');

  const cfg  = getCfg();
  const ctrl = new AbortController();
  const t    = setTimeout(()=>ctrl.abort(), 15000);

  try{
    const resp = await fetch(cfg.url,{
      method:'POST',
      headers:{'Content-Type':'text/plain; charset=utf-8'},
      body: codigo,
      signal: ctrl.signal
    });
    clearTimeout(t);
    const text = await resp.text();
    renderResults(text);
  } catch(err){
    clearTimeout(t);
    document.getElementById('overlay').classList.add('show');
    setStatus('err','sin conexión');
  } finally{
    btn.classList.remove('loading');
    btn.textContent = '▶ COMPILAR';
  }
}

// código de muestra
textarea.value = `inicio
  entero x = 10;
  entero y = 20;
  real resultado;

  resultado = x + y;
  escribir(resultado);

  si (x < y) entonces {
    escribir("x es menor");
  } sino {
    escribir("y es mayor o igual");
  }
fin`;
updateLineNumbers();
</script>
</body>
</html>
